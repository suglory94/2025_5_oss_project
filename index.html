<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!--ëª¨ë°”ì¼ ê¹¨ì§ ë°©ì§€-->
    <title>í‰í–‰ìš°ì£¼ì‹œë®¬ë ˆì´ì…˜</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div class="container" id="homeScreen">
        <!-- ë°°ê²½ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ -->
        <div class="background-effects">
            <div class="effect-circle effect-1"></div>
            <div class="effect-circle effect-2"></div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="content">
            <h1 class="title">í‰í–‰ìš°ì£¼ì‹œë®¬ë ˆì´ì…˜</h1>

            <div class="button-group">
                <button class="btn btn-outline" onclick="showHistory()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    íˆìŠ¤í† ë¦¬
                </button>

                <button class="btn btn-primary" onclick="startSimulation()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    ì‹œì‘
                </button>

                <button class="btn btn-outline" onclick="showTimetableScreen()">
                    <svg class="icon-time" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7" />
                        <path
                            d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z" />
                    </svg>
                    ì‹œê°„í‘œ ì…ë ¥
                </button>

            </div>
        </div>
    </div>

    <div class="full-screen-container choice-screen" id="choiceScreen">
        <div class="aurora-background">
            <div class="aurora-effect aurora-1"></div>
            <div class="aurora-effect aurora-2"></div>
            <div class="aurora-effect aurora-3"></div>
        </div>

        <div class="choice-content">
            <h2 id="choice-question" class="question-box">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>
            <p id="choice-context"></p>
            <form id="activity-choice-form"
                style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                <div id="choice-options-container" class="choices-wrapper">
                    <button class="choice-item"><span>ì„ íƒì§€ A</span></button>
                    <button class="choice-item"><span>ì„ íƒì§€ B</span></button>
                </div>

                <div style="width: 100%; max-width: 460px; margin-top: 30px;">
                    <div id="cost-input-area" class="input-area" style="display: none; margin-bottom: 20px;">
                        <label for="cost-value" id="cost-prompt-label"
                            style="display: block; margin-bottom: 5px; font-weight: 600;">ë¹„ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:</label>
                        <input type="number" id="cost-value" value="0" min="-10000000" max="10000000"
                            style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #8b5cf6; background: rgba(0, 0, 0, 0.4); color: #f0f0f5;">
                    </div>

                    <div id="description-input-area" class="input-area" style="display: none; margin-bottom: 20px;">
                        <label for="custom-description"
                            style="display: block; margin-bottom: 5px; font-weight: 600;">ìì„¸í•œ í™œë™ ì„¤ëª…:</label>
                        <input type="text" id="custom-description" placeholder="ì˜ˆ: ì¹œêµ¬ì™€ ë–¡ë³¶ì´ ë¨¹ê¸°"
                            style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #8b5cf6; background: rgba(0, 0, 0, 0.4); color: #f0f0f5;">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="save-choice-btn"
                    style="width: 100%; max-width: 460px; margin-top: 10px;">ì„ íƒ ì €ì¥</button>
            </form>
        </div>

        <button class="back-btn" onclick="goBackToHome()">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            ëŒì•„ê°€ê¸°
        </button>
    </div>

    <div class="full-screen-container timetable-screen" id="timetableScreen">
        <div class="timetable-container">
            <h2 class="timetable-title">ì‹œê°„í‘œ ë° ì˜ˆì‚° ì„¤ì •</h2>

            <!-- ì´ˆê¸°í™” ë²„íŠ¼ ì¶”ê°€ -->
            <button type="button" class="btn btn-outline" onclick="resetAllData()"
                style="width: 100%; margin-bottom: 20px; background: rgba(220, 38, 38, 0.2); border-color: rgba(220, 38, 38, 0.6); color: #fca5a5;">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
                </svg>
                âš ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
            </button>

            <form id="schedule-form-full" style="width: 100%;">
                <div
                    style="margin-bottom: 30px; padding: 20px; border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 10px; background: rgba(0, 0, 0, 0.2);">
                    <label for="initial-budget-full" style="display: block; margin-bottom: 10px; font-weight: 600;">ì´ˆê¸°
                        ì£¼ê°„ ì˜ˆì‚° (ì›):</label>
                    <input type="number" id="initial-budget-full" value="10000" min="0" required
                        style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #8b5cf6; background: rgba(0, 0, 0, 0.4); color: #f0f0f5;">
                </div>

                <div class="timetable-wrapper">
                    <table class="timetable">
                        <thead>
                            <tr>
                                <th class="period-header">êµì‹œ</th>
                                <th class="day-header">ì›”</th>
                                <th class="day-header">í™”</th>
                                <th class="day-header">ìˆ˜</th>
                                <th class="day-header">ëª©</th>
                                <th class="day-header">ê¸ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="timetableBody">
                        </tbody>
                    </table>
                    <div class="timetable-hint">
                        í´ë¦­í•´ì„œ ì‹œê°„í‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì„¤ì • ë° ì‹œê°„í‘œ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ìµœì¢… ì „ì†¡)
                    </div>
                </div>

                <button type="submit" class="btn btn-primary"
                    style="width: 100%; margin-top: 40px; height: 60px; font-size: 1.2rem;">ì„¤ì • ë° ì‹œê°„í‘œ ì €ì¥</button>
            </form>
        </div>

        <button class="timetable-back" onclick="goBackToHome()">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            ëŒì•„ê°€ê¸°
        </button>
    </div>

    <div class="modal-overlay" id="timetableModal" onclick="closeTimetableModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modalTitle" style="color: #8b5cf6; margin-bottom: 15px;">ì‹œê°„ ì…ë ¥</h3>
            <input type="text" id="timetableInput" class="timetable-input" placeholder="ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn btn btn-outline" onclick="closeTimetableModal()">ì·¨ì†Œ</button>
                <button class="modal-btn confirm-btn btn btn-primary" onclick="saveTimetableCell()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- íˆìŠ¤í† ë¦¬ í™”ë©´ -->
    <div class="full-screen-container history-screen" id="historyScreen" style="display: none;">
        <div class="history-container">
            <!-- ìƒë‹¨ í—¤ë” ì˜ì—­ -->
            <div class="history-header-row">
                <h2 class="history-title">ğŸ•°ï¸ í‰í–‰ ìš°ì£¼ íˆìŠ¤í† ë¦¬</h2>

                <button class="btn btn-outline back-btn-inline" onclick="goBackToHome()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                    ëŒì•„ê°€ê¸°
                </button>
            </div>

            <!-- ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
            <div id="historyList" class="history-list">
                <p style="text-align: center; color: #aaa;">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

    </div>

    <script>
        let selectedChoice = null;
        let parallelChoiceData = null; // í‰í–‰ ìš°ì£¼ ë°ì´í„°
        let currentQuestionData = null;
        let timetableData = []; // ì‹œê°„í‘œ ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´
        let currentCellKey = '';

        let allFinalOptions = [];

        const DAYS_KR = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ"];
        const DAYS = ["monday", "tuesday", "wednesday", "thursday", "friday"];
        const PERIODS = [1, 2, 3, 4, 5, 6];

        const TEMP_PERIOD_TIMES = {
            1: { start: "09:00", end: "10:15" },
            2: { start: "10:30", end: "11:45" },
            3: { start: "12:00", end: "13:15" },
            4: { start: "13:30", end: "14:45" },
            5: { start: "15:00", end: "16:15" },
            6: { start: "16:30", end: "17:45" }
        };

        // ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        function goBackToHome() {
            document.getElementById('choiceScreen').style.display = 'none';
            document.getElementById('timetableScreen').style.display = 'none';
            document.getElementById('homeScreen').style.display = 'flex'; // ë©”ì¸ í™”ë©´ì´ flexë¡œ ê°€ì •
        }

        // íˆìŠ¤í† ë¦¬ ë²„íŠ¼
        async function showHistory() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('historyScreen').style.display = 'flex';
            document.getElementById('historyList').innerHTML = '<p style="text-align: center; color: #8b5cf6;">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

            try {
                const response = await fetch(`http://localhost:3000/api/hourly/history`);
                const data = await response.json();

                if (response.status === 200) {
                    const actual = data.actual_universe || [];
                    const parallel = data.parallel_universe || [];

                    const historyMap = new Map();

                    actual.forEach(choice => {
                        const key = `${choice.day}-${choice.hour}`;
                        historyMap.set(key, { actual: choice, parallels: [] });
                    });

                    parallel.forEach(branch => {
                        const key = `${branch.day}-${branch.hour}`;
                        if (historyMap.has(key)) {
                            historyMap.get(key).parallels.push(branch);
                        }
                    });

                    const mergedData = Array.from(historyMap.values()).sort((a, b) => {
                        if (a.actual.day !== b.actual.day) {
                            return a.actual.day - b.actual.day;
                        }
                        return a.actual.hour - b.actual.hour;
                    });

                    renderHistoryList(mergedData);
                } else {
                    document.getElementById('historyList').innerHTML = `<p style="color: red; text-align: center;">ì˜¤ë¥˜: ${data.message}</p>`;
                }
            } catch (error) {
                console.error('íˆìŠ¤í† ë¦¬ ì˜¤ë¥˜:', error);
                document.getElementById('historyList').innerHTML = `<p style="color: red; text-align: center;">í†µì‹  ì˜¤ë¥˜</p>`;
            }
        }

        // ì‹œê°„í‘œ ë²„íŠ¼
        async function showTimetableScreen() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('timetableScreen').style.display = 'flex';
            // ì €ì¥ëœ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
            await loadSavedTimetable();

            // í‘œ ë Œë”ë§
            initTimetableBody();
        }

        // ì‹œê°„í‘œ í‘œ ë‚´ë¶€ ë Œë”ë§
        function initTimetableBody() {
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = '';

            for (let period of PERIODS) {
                const row = document.createElement('tr');
                const periodCell = document.createElement('td');
                periodCell.className = 'period-cell';
                periodCell.textContent = period + 'êµì‹œ';
                row.appendChild(periodCell);

                for (let dayIndex = 0; dayIndex < DAYS_KR.length; dayIndex++) {
                    const cell = document.createElement('td');
                    cell.className = 'timetable-cell';
                    const cellKey = dayIndex + '-' + period;
                    const cellData = timetableData.find(d => d.key === cellKey);
                    cell.textContent = cellData ? cellData.value : '';
                    cell.onclick = () => openTimetableModal(cellKey, period, DAYS_KR[dayIndex]);
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            }
        }

        // ì‹œê°„í‘œ ì…€ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
        function openTimetableModal(cellKey, period, day) {
            currentCellKey = cellKey;
            const cellData = timetableData.find(d => d.key === cellKey);
            document.getElementById('modalTitle').textContent = day + 'ìš”ì¼ ' + period + 'êµì‹œ';
            document.getElementById('timetableInput').value = cellData ? cellData.value : '';
            document.getElementById('timetableModal').style.display = 'flex';
            document.getElementById('timetableInput').focus();
        }

        // ì‹œê°„í‘œ ëª¨ë‹¬ ë‹«ê¸°
        function closeTimetableModal() {
            document.getElementById('timetableModal').style.display = 'none';
            document.getElementById('timetableInput').value = '';
            currentCellKey = '';
        }

        // ì‹œê°„í‘œ ì…€ ë°ì´í„° ì €ì¥
        function saveTimetableCell() {
            const value = document.getElementById('timetableInput').value.trim();

            if (value === '') {
                timetableData = timetableData.filter(d => d.key !== currentCellKey);
            } else {
                const existingIndex = timetableData.findIndex(d => d.key === currentCellKey);
                if (existingIndex >= 0) {
                    timetableData[existingIndex].value = value;
                } else {
                    timetableData.push({ key: currentCellKey, value: value });
                }
            }

            closeTimetableModal();
            initTimetableBody();
        }

        // ì‹œê°„í‘œ ë° ì˜ˆì‚° ì„¤ì • í¼ ì œì¶œ í•¸ë“¤ëŸ¬ (ë°±ì—”ë“œ ì „ì†¡)
        document.getElementById('schedule-form-full').addEventListener('submit', async (e) => {
            e.preventDefault();

            const initialBudget = parseInt(document.getElementById('initial-budget-full').value, 10);

            if (isNaN(initialBudget) || initialBudget < 0) {
                alert("ìœ íš¨í•œ ì´ˆê¸° ì£¼ê°„ ì˜ˆì‚°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const schedule = {};
            // timetable_arrayëŠ” ìˆ˜ì—…ì´ ìˆëŠ” ì‹œê°„(1)ê³¼ ì—†ëŠ” ì‹œê°„(0)ì„ ë‚˜íƒ€ë‚´ëŠ” 5x6 ë°°ì—´
            const timetable_array = Array(DAYS.length).fill(null).map(() => Array(PERIODS.length).fill(0));

            // ëª¨ë“  ìš”ì¼ì„ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
            DAYS.forEach(dayName => {
                schedule[dayName] = [];
            });

            // timetableData ë°°ì—´ì„ ê¸°ë°˜ìœ¼ë¡œ ë°±ì—”ë“œìš© ë°ì´í„° ìƒì„±
            timetableData.forEach(item => {
                const [dayIndex, period] = item.key.split('-').map(Number);
                const dayName = DAYS[dayIndex];
                const subject = item.value;
                const periodNum = period;

                if (subject) {
                    const timeDetail = TEMP_PERIOD_TIMES[periodNum];

                    const newClass = {
                        subject: subject,
                        start: timeDetail.start,
                        end: timeDetail.end
                    };

                    if (!schedule[dayName]) {
                        schedule[dayName] = [];
                    }
                    schedule[dayName].push(newClass);

                    const periodIndex = periodNum - 1;
                    if (dayIndex !== -1 && periodIndex !== -1) {
                        timetable_array[dayIndex][periodIndex] = 1;
                    }
                }
            });

            // ë°±ì—”ë“œ API í˜¸ì¶œ
            try {
                const response = await fetch(`http://localhost:3000/api/hourly/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        schedule,
                        initialBudget,
                        timetable_array
                    })
                });

                const data = await response.json();

                if (response.status === 201) {
                    alert(`ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ˆê¸° ì˜ˆì‚°: ${data.settings.initialBudget.toLocaleString()}ì›`);
                    goBackToHome();
                }
                else {
                    alert(`ì„¤ì • ì €ì¥ ì˜¤ë¥˜: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('ì‹œê°„í‘œ ì €ì¥ ì˜¤ë¥˜: ', error);
                alert(`ì„œë²„ì™€ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
            }
        });


        // ì‹œì‘ ë²„íŠ¼ í•¸ë“¤ëŸ¬: AI ì§ˆë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°
        async function startSimulation() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('choiceScreen').style.display = 'flex';

            try {
                const response = await fetch(`http://localhost:3000/api/hourly/question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (response.status === 200) {
                    currentQuestionData = data;
                    renderChoiceScreen(data);
                }
                else {
                    alert(`ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ì˜¤ë¥˜: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                    goBackToHome();
                }
            }
            catch (error) {
                console.error('ì§ˆë¬¸ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜: ', error);
                alert(`ì„œë²„ì™€ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
                goBackToHome();
            }
        }

        // ì„ íƒ í™”ë©´ ë Œë”ë§
        function renderChoiceScreen(data) {
            // 1. data ìœ íš¨ì„± ê²€ì‚¬ ê°•í™”
            if (!data) {
                alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                goBackToHome();
                return;
            }

            // 2. ë©”ì‹œì§€ë§Œ ìˆê³  ì„ íƒì§€(options)ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
            if (!data.options || !Array.isArray(data.options) || data.options.length === 0) {
                document.getElementById('choice-question').textContent = data.message || "í‘œì‹œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
                document.getElementById('choice-context').textContent = "";
                document.getElementById('choice-options-container').innerHTML = ''; // ë²„íŠ¼ ë¹„ìš°ê¸°

                document.getElementById('cost-input-area').style.display = 'none';
                document.getElementById('description-input-area').style.display = 'none';
                document.getElementById('save-choice-btn').style.display = 'none';

                return;
            }

            // ì •ìƒì ì¸ ì§ˆë¬¸ í‘œì‹œ
            document.getElementById('choice-question').textContent = data.question;

            // ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const dayNameKr = data.day !== undefined && data.day >= 0 && data.day < 5 ? DAYS_KR[data.day] : 'ì˜¤ëŠ˜';
            document.getElementById('choice-context').textContent = `ìœ í˜•: ${data.choiceType} (${data.subject || dayNameKr} ${data.hour}ì‹œ)`;

            const optionsContainer = document.getElementById('choice-options-container');
            optionsContainer.innerHTML = '';

            // optionsê°€ í™•ì‹¤íˆ ë°°ì—´ì¼ ë•Œë§Œ ì‹¤í–‰ë¨
            data.options.forEach(option => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'choice-item';
                button.innerHTML = `<span>${option.label}</span>`;

                button.dataset.value = option.value;
                button.dataset.hasCost = option.hasCost;
                button.dataset.costPrompt = option.costPrompt || '';
                button.dataset.needsDescription = option.needsDescription || false;

                button.dataset.optionData = JSON.stringify({
                    value: option.value,
                    label: option.label,
                    category: option.category || ''
                });

                button.addEventListener('click', handleOptionSelect);
                optionsContainer.appendChild(button);
            });

            // ì´ˆê¸°í™”
            selectedChoice = null;
            parallelChoiceData = null;
            document.getElementById('cost-input-area').style.display = 'none';
            document.getElementById('description-input-area').style.display = 'none';
            document.getElementById('cost-value').value = 0;
            document.getElementById('custom-description').value = '';
            document.getElementById('save-choice-btn').style.display = 'block';
        }

        // ì„ íƒì§€ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
        function handleOptionSelect(event) {
            const btn = event.currentTarget;
            const buttons = document.querySelectorAll('#choice-options-container .choice-item');

            // ì„ íƒ í•˜ì´ë¼ì´íŠ¸
            buttons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');

            selectedChoice = btn.dataset.value;

            // ì¡°ê±´ë¬¸ ë‹¨ìˆœí™”
            if (btn.dataset.value === 'attend_base' || btn.dataset.value === 'skip_base') {
                const subject = currentQuestionData.subject || "ìˆ˜ì—…"; // subjectê°€ ì—†ì„ ê²½ìš° ëŒ€ë¹„

                fetchBranchQuestion(currentQuestionData.day, currentQuestionData.hour, subject, btn.dataset.value);

                document.getElementById('save-choice-btn').style.display = 'none';

                return;
            }

            // í‰í–‰ ìš°ì£¼ ë°ì´í„°
            const unselectedButtons = Array.from(buttons).filter(b => !b.classList.contains('selected'));

            window.currentParallelChoices = [];

            unselectedButtons.forEach(otherBtn => {
                let data = {};

                try {
                    data = JSON.parse(otherBtn.dataset.optionData || '{}');
                } catch (e) {
                    console.error("Option Data íŒŒì‹± ì˜¤ë¥˜:", e);
                }

                window.currentParallelChoices.push({
                    value: data.value || otherBtn.dataset.value,
                    label: data.label || otherBtn.innerText,
                    category: data.category || '',
                    cost: 0,
                    description: `(í‰í–‰ìš°ì£¼) '${data.label || otherBtn.innerText}' ì„ íƒ`
                });
            });

            // ë¹„ìš© ë° ì„¤ëª… ì…ë ¥ë€
            let selectedOptionData = {};
            try {
                selectedOptionData = JSON.parse(btn.dataset.optionData || '{}');
            } catch (e) { }

            const hasCost = btn.dataset.hasCost === 'true';
            const needsDescription = btn.dataset.needsDescription === 'true';

            const costArea = document.getElementById('cost-input-area');
            const descArea = document.getElementById('description-input-area');
            const saveBtn = document.getElementById('save-choice-btn');

            if (hasCost) {
                costArea.style.display = 'block';
                document.getElementById('cost-prompt-label').textContent = btn.dataset.costPrompt || 'ë¹„ìš©ì€ ì–¼ë§ˆì˜€ë‚˜ìš”?';
            } else {
                costArea.style.display = 'none';
                document.getElementById('cost-value').value = 0;
            }

            if (needsDescription) {
                descArea.style.display = 'block';
            } else {
                descArea.style.display = 'none';
                document.getElementById('custom-description').value = '';
            }

            saveBtn.style.display = 'block';
        }

        // 2ë‹¨ê³„ ì§ˆë¬¸
        async function fetchBranchQuestion(day, hour, subject, baseChoice) {
            const response = await fetch(`http://localhost:3000/api/hourly/branch-question`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ day, hour, subject, baseChoice })
            });

            if (response.ok) {
                const branchData = await response.json();

                updateQuestionUI(branchData);

            } else {
                alert("2ë‹¨ê³„ ì§ˆë¬¸ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // 2ë‹¨ê³„ UI ì—…ë°ì´íŠ¸
        function updateQuestionUI(data) {
            currentQuestionData = data;

            // ì§ˆë¬¸ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            document.getElementById('choice-question').textContent = data.question;

            // ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const dayNameKr = data.day !== undefined && data.day >= 0 && data.day < 5 ? DAYS_KR[data.day] : 'ì˜¤ëŠ˜';
            document.getElementById('choice-context').textContent = `ìœ í˜•: ${data.choiceType} (${data.subject || dayNameKr} ${data.hour}ì‹œ)`;

            const optionsContainer = document.getElementById('choice-options-container');
            optionsContainer.innerHTML = '';

            data.options.forEach(option => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'choice-item';
                button.innerHTML = `<span>${option.label}</span>`;

                // ë°ì´í„°ì…‹ ë°”ì¸ë”©
                button.dataset.value = option.value;
                button.dataset.hasCost = option.hasCost;
                button.dataset.costPrompt = option.costPrompt || '';
                button.dataset.needsDescription = option.needsDescription || false;

                button.dataset.optionData = JSON.stringify({
                    value: option.value,
                    label: option.label,
                    category: option.category || ''
                });

                button.addEventListener('click', handleOptionSelect);
                optionsContainer.appendChild(button);
            });

            selectedChoice = null;
            document.getElementById('cost-input-area').style.display = 'none';
            document.getElementById('description-input-area').style.display = 'none';
            document.getElementById('save-choice-btn').style.display = 'none';
        }

        // í‰í–‰ìš°ì£¼ ë°ì´í„° ì „ì†¡
        document.getElementById('activity-choice-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedChoice) {
                alert('ì„ íƒì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const cost = parseInt(document.getElementById('cost-value').value, 10);
            const selectedOptionElement = document.querySelector(`#choice-options-container .choice-item[data-value="${selectedChoice}"]`);

            let customDescription = '';
            if (selectedOptionElement && selectedOptionElement.dataset.needsDescription === 'true') {
                customDescription = document.getElementById('custom-description').value.trim();
                if (!customDescription) {
                    alert("í™œë™ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
            }

            if (selectedOptionElement && selectedOptionElement.dataset.hasCost === 'true' && isNaN(cost)) {
                alert("ìœ íš¨í•œ ë¹„ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const parallelChoicesPayload = allFinalOptions
                .filter(option => option.value !== selectedChoice)
                .map(option => {
                    let oppositeCost = 0;
                    if (option.value === 'attend_coffee') oppositeCost = -4000;
                    if (option.value === 'skip_play') oppositeCost = -10000;

                    return {
                        value: option.value,
                        cost: oppositeCost,
                        label: option.label,
                    };
                });

            // ë°±ì—”ë“œë¡œ ë³´ë‚¼ ë°ì´í„°
            const payload = {
                day: currentQuestionData.day,
                hour: currentQuestionData.hour,
                choiceType: currentQuestionData.choiceType,
                subject: currentQuestionData.subject,

                choice: selectedChoice,
                cost: cost,
                duration: 75,
                customDescription: document.getElementById('custom-description').value.trim() || undefined,
                parallelChoices: window.currentParallelChoices || [],
            };

            // ë°±ì—”ë“œ API í˜¸ì¶œ
            try {
                const response = await fetch(`http://localhost:3000/api/hourly/choices`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.status === 201) {
                    alert(`í™œë™ ì €ì¥ ì™„ë£Œ!\n[ë‚˜ì˜ ìš°ì£¼] ${data.actual_universe.description}\n[í‰í–‰ ìš°ì£¼] ${data.parallel_universe.description}\ní˜„ì¬ ì˜ˆì‚°: ${data.actual_universe.currentBudget.toLocaleString()}ì›`);
                    goBackToHome();
                } else {
                    alert(`í™œë™ ì €ì¥ ì˜¤ë¥˜: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('í™œë™ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ì—”í„° í‚¤ ì…ë ¥ ì‹œ ì‹œê°„í‘œ ëª¨ë‹¬ ì €ì¥
        document.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('timetableInput');
            if (input) {
                input.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveTimetableCell();
                    }
                });
            }
            document.getElementById('homeScreen').style.display = 'flex';

            loadSavedTimetable();
        });

        function goBackToHome() {
            document.getElementById('choiceScreen').style.display = 'none';
            document.getElementById('timetableScreen').style.display = 'none';
            document.getElementById('historyScreen').style.display = 'none';
            document.getElementById('homeScreen').style.display = 'flex';
        }

        async function loadSavedTimetable() {
            try {
                const response = await fetch(`http://localhost:3000/api/hourly/settings`);

                if (response.status === 200) {
                    const data = await response.json();
                    const schedule = data.schedule;

                    timetableData = [];

                    DAYS.forEach((dayName, dayIndex) => {
                        const classesOnDay = schedule[dayName] || [];

                        classesOnDay.forEach(classInfo => {
                            for (let period = 1; period <= 6; period++) {
                                const periodTime = TEMP_PERIOD_TIMES[period];
                                if (classInfo.start === periodTime.start) {
                                    const cellKey = `${dayIndex}-${period}`;
                                    timetableData.push({
                                        key: cellKey,
                                        value: classInfo.subject
                                    });
                                    break;
                                }
                            }
                        });
                    });

                    document.getElementById('initial-budget-full').value = data.settings.initialBudget;

                    if (document.getElementById('timetableScreen').style.display === 'flex') {
                        initTimetableBody();
                    }
                }
            } catch (error) {
                console.error('ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            }
        }

        async function resetAllData() {
            const confirmed = confirm("âš ï¸ ê²½ê³ !\n\nëª¨ë“  ì„ íƒ íˆìŠ¤í† ë¦¬ì™€ í†µê³„ê°€ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");

            if (!confirmed) return;

            try {
                const response = await fetch(`http://localhost:3000/api/hourly/reset`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.status === 200) {
                    alert("âœ… ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");

                    timetableData = [];
                    initTimetableBody();
                } else {
                    alert(`ì´ˆê¸°í™” ì˜¤ë¥˜: ${data.message}`);
                }
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // íˆìŠ¤í† ë¦¬ ë²„íŠ¼
        async function showHistory() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('historyScreen').style.display = 'flex';
            document.getElementById('historyList').innerHTML = '<p style="text-align: center; color: #8b5cf6;">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

            try {
                const response = await fetch(`http://localhost:3000/api/hourly/history`);
                const data = await response.json();

                if (response.status === 200) {
                    const actual = data.actual_universe || [];
                    const parallel = data.parallel_universe || [];

                    const historyMap = new Map();

                    // 1. ì‹¤ì œ ìš°ì£¼ ë°ì´í„° ì¶”ê°€
                    actual.forEach(choice => {
                        const key = `${choice.day}-${choice.hour}`;
                        historyMap.set(key, { actual: choice, parallels: [] });
                    });

                    // 2. í‰í–‰ ìš°ì£¼ ë°ì´í„° ì—°ê²°
                    parallel.forEach(branch => {
                        const key = `${branch.day}-${branch.hour}`;
                        if (historyMap.has(key)) {
                            historyMap.get(key).parallels.push(branch);
                        }
                    });

                    // 3. ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (Day 0-11, Hour 0-23)
                    const mergedData = Array.from(historyMap.values()).sort((a, b) => {
                        if (a.actual.day !== b.actual.day) {
                            return a.actual.day - b.actual.day;
                        }
                        return a.actual.hour - b.actual.hour;
                    });

                    renderHistoryList(mergedData);
                } else {
                    document.getElementById('historyList').innerHTML = `<p style="color: red; text-align: center;">íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>`;
                }
            } catch (error) {
                console.error('íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜: ', error);
                document.getElementById('historyList').innerHTML = `<p style="color: red; text-align: center;">ì„œë²„ì™€ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
            }
        }

        // ë¶€í˜¸ì— ë”°ë¼ ìƒ‰ìƒ ì§€ì •
        function formatChange(value, unit) {
            if (value === null || value === undefined) return `0${unit}`;
            if (value > 0) {
                return `<span style="color: #6ee7b7;">+${value.toLocaleString()}${unit}</span>`; // Tailwind green-300
            } else if (value < 0) {
                return `<span style="color: #fca5a5;">${value.toLocaleString()}${unit}</span>`; // Tailwind red-300
            } else {
                return `0${unit}`;
            }
        }

        // íˆìŠ¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜
        function renderHistoryList(historyData) {
            const listContainer = document.getElementById('historyList');
            listContainer.innerHTML = '';

            if (!historyData || historyData.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #aaa;">ì•„ì§ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            historyData.forEach((entry) => {
                const a = entry.actual;
                const dayNameKr = DAYS_KR[a.day] || `Day ${a.day + 1}`;

                console.log('ì‹¤ì œ ìš°ì£¼ ë°ì´í„°:', a);
                let actualHtml = `
            <div class="universe-container actual-universe">
                <div class="universe-title">âœ¨ ë‚˜ì˜ ìš°ì£¼ ì„ íƒ (${dayNameKr} ${a.hour}ì‹œ)</div>
                <p class="universe-description">${a.description}</p>
                <div class="universe-stats">
                    <span>ğŸ’° ì¬ì •: ${formatChange(a.financeChange || 0, 'ì›')}</span>
                    <span>ğŸ“š í•™ìŠµ: ${formatChange(a.studyChangeMinutes || 0, 'ë¶„')}</span>
                    <span>ğŸ˜´ ìˆ˜ë©´: ${formatChange(a.sleepChangeMinutes || 0, 'ë¶„')}</span>
                </div>
            </div>
        `;

                // í‰í–‰ ìš°ì£¼ ì •ë³´
                let parallelHtml = '';
                if (entry.parallels.length === 0) {
                    parallelHtml = `
                <div class="universe-container parallel-universe no-parallel">
                    <div class="universe-title">ğŸŒŒ í‰í–‰ ìš°ì£¼</div>
                    <p class="universe-description">ê¸°ë¡ëœ í‰í–‰ ìš°ì£¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            `;
                } else {
                    entry.parallels.forEach((p, index) => {
                        console.log('í‰í–‰ ìš°ì£¼ ë°ì´í„°:', p);
                        parallelHtml += `
                    <div class="universe-container parallel-universe ${index > 0 ? 'mt-2' : ''}">
                        <div class="universe-title">ğŸŒŒ í‰í–‰ ìš°ì£¼ (ì„ íƒí•˜ì§€ ì•Šì€ ê¸¸)</div>
                        <p class="universe-description">${p.oppositeDescription}</p>
                        <div class="universe-stats">
                            <span>ğŸ’° ì¬ì •: ${formatChange(p.oppositeFinanceChange || 0, 'ì›', true)}</span>
                            <span>ğŸ“š í•™ìŠµ: ${formatChange(p.oppositeStudyChangeMinutes || 0, 'ë¶„', false)}</span>
                            <span>ğŸ˜´ ìˆ˜ë©´: ${formatChange(p.oppositeSleepChangeMinutes || 0, 'ë¶„', false)}</span>
                        </div>
                    </div>
                `;
                    });
                }

                const itemHtml = `
            <div class="history-item">
                <div class="history-header">
                    <span class="history-time">${dayNameKr} ${a.hour}ì‹œ</span>
                    <span class="history-type">${a.choiceType || 'ì¼ë°˜ í™œë™'}</span>
                </div>
                ${actualHtml}
                ${parallelHtml}
            </div>
        `;
                listContainer.insertAdjacentHTML('beforeend', itemHtml);
            });
        }
    </script>
</body>

</html>