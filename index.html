<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‰í–‰ìš°ì£¼ì‹œë®¬ë ˆì´ì…˜</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div class="container" id="homeScreen">
        <div class="background-effects">
            <div class="effect-circle effect-1"></div>
            <div class="effect-circle effect-2"></div>
        </div>

        <div class="content">
            <h1 class="title">í‰í–‰ìš°ì£¼ì‹œë®¬ë ˆì´ì…˜</h1>

            <!-- ì‚¬ìš©ì ID ì…ë ¥ ì„¹ì…˜ -->
            <div class="user-id-section">
                <div class="user-id-label">ğŸ‘¤ ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
                <input type="text" id="userIdInput" class="user-id-input" placeholder="ì˜ˆ: student01" maxlength="20">
                <button class="btn btn-primary" id="setUserIdBtn" onclick="handleUserIdInput()"
                    style="margin-top: 15px; width: 100%; max-width: 320px; height: 48px;">
                    ë¡œê·¸ì¸
                </button>
                <div class="current-user-display" id="currentUserDisplay" style="display: none;">
                    âœ… ë¡œê·¸ì¸ ì™„ë£Œ: <strong id="currentUserName"></strong>
                    <button class="btn btn-outline logout-btn" onclick="logoutUser()">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>

            <div class="button-group" id="mainButtons" style="display: none;">
                <button class="btn btn-outline" onclick="showHistory()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    íˆìŠ¤í† ë¦¬
                </button>

                <button class="btn btn-primary" onclick="startSimulation()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    ì‹œì‘
                </button>

                <button class="btn btn-outline" onclick="showTimetableScreen()">
                    <svg class="icon-time" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7" />
                        <path
                            d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z" />
                    </svg>
                    ì‹œê°„í‘œ ì…ë ¥
                </button>
            </div>
        </div>
    </div>

    <div class="full-screen-container choice-screen" id="choiceScreen">
        <div class="aurora-background">
            <div class="aurora-effect aurora-1"></div>
            <div class="aurora-effect aurora-2"></div>
            <div class="aurora-effect aurora-3"></div>
        </div>

        <div class="choice-content">
            <h2 id="choice-question" class="question-box">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>
            <p id="choice-context"></p>
            <form id="activity-choice-form"
                style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                <div id="choice-options-container" class="choices-wrapper">
                    <button class="choice-item"><span>ì„ íƒì§€ A</span></button>
                    <button class="choice-item"><span>ì„ íƒì§€ B</span></button>
                </div>

                <div style="width: 100%; max-width: 460px; margin-top: 30px;">
                    <div id="cost-input-area" class="input-area" style="display: none; margin-bottom: 20px;">
                        <label for="cost-value" id="cost-prompt-label"
                            style="display: block; margin-bottom: 5px; font-weight: 600;">ë¹„ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:</label>
                        <input type="number" id="cost-value" value="0" min="-10000000" max="10000000"
                            style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #8b5cf6; background: rgba(0, 0, 0, 0.4); color: #f0f0f5;">
                    </div>

                    <div id="description-input-area" class="input-area" style="display: none; margin-bottom: 20px;">
                        <label for="custom-description"
                            style="display: block; margin-bottom: 5px; font-weight: 600;">ìì„¸í•œ í™œë™ ì„¤ëª…:</label>
                        <input type="text" id="custom-description" placeholder="ì˜ˆ: ì¹œêµ¬ì™€ ë–¡ë³¶ì´ ë¨¹ê¸°"
                            style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #8b5cf6; background: rgba(0, 0, 0, 0.4); color: #f0f0f5;">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="save-choice-btn"
                    style="width: 100%; max-width: 460px; margin-top: 10px;">ì„ íƒ ì €ì¥</button>
            </form>
        </div>

        <button class="back-btn" onclick="goBackToHome()">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            ëŒì•„ê°€ê¸°
        </button>
    </div>

    <div class="full-screen-container timetable-screen" id="timetableScreen">
        <div class="timetable-container">
            <h2 class="timetable-title">ì‹œê°„í‘œ ë° ì˜ˆì‚° ì„¤ì •</h2>

            <button type="button" class="btn btn-outline" onclick="resetAllData()"
                style="width: 100%; margin-bottom: 20px; background: rgba(220, 38, 38, 0.2); border-color: rgba(220, 38, 38, 0.6); color: #fca5a5;">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
                </svg>
                âš ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
            </button>

            <form id="schedule-form-full" style="width: 100%;">
                <div
                    style="margin-bottom: 30px; padding: 20px; border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 10px; background: rgba(0, 0, 0, 0.2);">
                    <label for="initial-budget-full" style="display: block; margin-bottom: 10px; font-weight: 600;">ì´ˆê¸°
                        ì£¼ê°„ ì˜ˆì‚° (ì›):</label>
                    <input type="number" id="initial-budget-full" value="10000" min="0" required
                        style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #8b5cf6; background: rgba(0, 0, 0, 0.4); color: #f0f0f5;">
                </div>

                <div class="timetable-wrapper">
                    <table class="timetable">
                        <thead>
                            <tr>
                                <th class="period-header">êµì‹œ</th>
                                <th class="day-header">ì›”</th>
                                <th class="day-header">í™”</th>
                                <th class="day-header">ìˆ˜</th>
                                <th class="day-header">ëª©</th>
                                <th class="day-header">ê¸ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="timetableBody"></tbody>
                    </table>
                    <div class="timetable-hint">
                        í´ë¦­í•´ì„œ ì‹œê°„í‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì„¤ì • ë° ì‹œê°„í‘œ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ìµœì¢… ì „ì†¡)
                    </div>
                </div>

                <button type="submit" class="btn btn-primary"
                    style="width: 100%; margin-top: 40px; height: 60px; font-size: 1.2rem;">ì„¤ì • ë° ì‹œê°„í‘œ ì €ì¥</button>
            </form>
        </div>

        <button class="timetable-back" onclick="goBackToHome()">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            ëŒì•„ê°€ê¸°
        </button>
    </div>

    <div class="modal-overlay" id="timetableModal" onclick="closeTimetableModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modalTitle" style="color: #8b5cf6; margin-bottom: 15px;">ì‹œê°„ ì…ë ¥</h3>
            <input type="text" id="timetableInput" class="timetable-input" placeholder="ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn btn btn-outline" onclick="closeTimetableModal()">ì·¨ì†Œ</button>
                <button class="modal-btn confirm-btn btn btn-primary" onclick="saveTimetableCell()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="full-screen-container history-screen" id="historyScreen" style="display: none;">
        <div class="history-container">
            <div class="history-header-row">
                <h2 class="history-title">ğŸ•°ï¸ í‰í–‰ ìš°ì£¼ íˆìŠ¤í† ë¦¬</h2>
                <button class="btn btn-outline back-btn-inline" onclick="goBackToHome()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                    ëŒì•„ê°€ê¸°
                </button>
            </div>

            <div id="totalScoresSummary"
                style="margin: 20px 0; padding: 25px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border-radius: 15px; border: 2px solid rgba(139, 92, 246, 0.3);">
                <h3 style="color: #8b5cf6; margin-bottom: 20px; font-size: 1.3rem; text-align: center;">ğŸ“Š ëˆ„ì  ì ìˆ˜ ìš”ì•½</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div
                        style="padding: 20px; background: rgba(139, 92, 246, 0.15); border-radius: 12px; border: 2px solid rgba(139, 92, 246, 0.4);">
                        <h4 style="color: #a78bfa; margin-bottom: 15px; font-size: 1.1rem; text-align: center;">âœ¨ ë‚˜ì˜ ìš°ì£¼
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                <span style="font-weight: 600;">ğŸ’° ì¬ì •:</span>
                                <span id="myTotalFinance"
                                    style="font-size: 1.2rem; font-weight: bold; color: #6ee7b7;">+0ì›</span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                <span style="font-weight: 600;">ğŸ“š í•™ìŠµ:</span>
                                <span id="myTotalStudy"
                                    style="font-size: 1.2rem; font-weight: bold; color: #6ee7b7;">+0ë¶„</span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                <span style="font-weight: 600;">ğŸ˜´ ìˆ˜ë©´:</span>
                                <span id="myTotalSleep"
                                    style="font-size: 1.2rem; font-weight: bold; color: #6ee7b7;">+0ë¶„</span>
                            </div>
                        </div>
                    </div>

                    <div
                        style="padding: 20px; background: rgba(245, 158, 11, 0.15); border-radius: 12px; border: 2px solid rgba(245, 158, 11, 0.4);">
                        <h4 style="color: #fbbf24; margin-bottom: 15px; font-size: 1.1rem; text-align: center;">ğŸŒŒ í‰í–‰ ìš°ì£¼
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                <span style="font-weight: 600;">ğŸ’° ì¬ì •:</span>
                                <span id="parallelTotalFinance"
                                    style="font-size: 1.2rem; font-weight: bold; color: #fbbf24;">+0ì›</span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                <span style="font-weight: 600;">ğŸ“š í•™ìŠµ:</span>
                                <span id="parallelTotalStudy"
                                    style="font-size: 1.2rem; font-weight: bold; color: #fbbf24;">+0ë¶„</span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                <span style="font-weight: 600;">ğŸ˜´ ìˆ˜ë©´:</span>
                                <span id="parallelTotalSleep"
                                    style="font-size: 1.2rem; font-weight: bold; color: #fbbf24;">+0ë¶„</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 10px;">
                    <h4 style="color: #c084fc; margin-bottom: 10px; font-size: 1rem; text-align: center;">ğŸ”„ ì°¨ì´ ë¶„ì„</h4>
                    <div style="display: flex; justify-content: space-around; font-size: 0.95rem;">
                        <div style="text-align: center;">
                            <div style="color: #a78bfa;">ğŸ’° ì¬ì • ì°¨ì´</div>
                            <div id="financeDiff" style="font-weight: bold; font-size: 1.1rem; margin-top: 5px;">0ì›
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #a78bfa;">ğŸ“š í•™ìŠµ ì°¨ì´</div>
                            <div id="studyDiff" style="font-weight: bold; font-size: 1.1rem; margin-top: 5px;">0ë¶„</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #a78bfa;">ğŸ˜´ ìˆ˜ë©´ ì°¨ì´</div>
                            <div id="sleepDiff" style="font-weight: bold; font-size: 1.1rem; margin-top: 5px;">0ë¶„</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="historyList" class="history-list">
                <p style="text-align: center; color: #aaa;">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <div id="three-container" style="width:1000px;height:1200px;margin:20px auto;"></div>
    </div>

    <script>
        let currentUserId = null;
        let selectedChoice = null;
        let parallelChoiceData = null;
        let currentQuestionData = null;
        let timetableData = [];
        let currentCellKey = '';
        let allFinalOptions = [];

        const DAYS_KR = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ"];
        const DAYS = ["monday", "tuesday", "wednesday", "thursday", "friday"];
        const PERIODS = [1, 2, 3, 4, 5, 6];

        const TEMP_PERIOD_TIMES = {
            1: { start: "09:00", end: "10:15" },
            2: { start: "10:30", end: "11:45" },
            3: { start: "12:00", end: "13:15" },
            4: { start: "13:30", end: "14:45" },
            5: { start: "15:00", end: "16:15" },
            6: { start: "16:30", end: "17:45" }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²˜ë¦¬
        document.addEventListener('DOMContentLoaded', function () {
            // ì—”í„° í‚¤ ì²˜ë¦¬
            document.getElementById('userIdInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    handleUserIdInput();
                }
            });

            // ì‹œê°„í‘œ ëª¨ë‹¬ ì—”í„° í‚¤
            const input = document.getElementById('timetableInput');
            if (input) {
                input.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveTimetableCell();
                    }
                });
            }
        });

        // ì‚¬ìš©ì ID ì…ë ¥ ì²˜ë¦¬
        function handleUserIdInput() {
            const userId = document.getElementById('userIdInput').value.trim();

            if (!userId) {
                alert('ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!/^[a-zA-Z0-9_-]+$/.test(userId)) {
                alert('ì‚¬ìš©ì IDëŠ” ì˜ë¬¸, ìˆ«ì, -, _ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            setUserId(userId);
        }

        // ì‚¬ìš©ì ID ì„¤ì •
        function setUserId(userId) {
            currentUserId = userId;

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('userIdInput').disabled = true;
            document.getElementById('setUserIdBtn').style.display = 'none';
            document.getElementById('currentUserDisplay').style.display = 'block';
            document.getElementById('currentUserName').textContent = userId;
            document.getElementById('mainButtons').style.display = 'flex';

            console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', userId);
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logoutUser() {
            if (!confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            currentUserId = null;

            // UI ì´ˆê¸°í™”
            document.getElementById('userIdInput').value = '';
            document.getElementById('userIdInput').disabled = false;
            document.getElementById('setUserIdBtn').style.display = 'block';
            document.getElementById('currentUserDisplay').style.display = 'none';
            document.getElementById('mainButtons').style.display = 'none';

            console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
        }

        // API í˜¸ì¶œ ì‹œ userIdë¥¼ í¬í•¨í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        async function fetchWithUserId(url, options = {}) {
            if (!currentUserId) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!');
                throw new Error('User ID not set');
            }

            // GETê³¼ DELETE ìš”ì²­ì€ query parameterë¡œ ì¶”ê°€
            if (!options.method || options.method === 'GET' || options.method === 'DELETE') {
                const separator = url.includes('?') ? '&' : '?';
                url = `${url}${separator}userId=${encodeURIComponent(currentUserId)}`;
            }
            // POST/PUT ìš”ì²­ì€ bodyì— ì¶”ê°€
            else {
                if (options.body) {
                    // bodyê°€ ì´ë¯¸ JSON ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹±
                    let bodyData;
                    try {
                        bodyData = typeof options.body === 'string'
                            ? JSON.parse(options.body)
                            : options.body;
                    } catch (e) {
                        console.error('Body parsing error:', e);
                        bodyData = {};
                    }

                    bodyData.userId = currentUserId;
                    options.body = JSON.stringify(bodyData);

                    // headersê°€ ì—†ìœ¼ë©´ ì¶”ê°€
                    if (!options.headers) {
                        options.headers = {};
                    }
                    options.headers['Content-Type'] = 'application/json';
                } else {
                    options.body = JSON.stringify({ userId: currentUserId });
                    options.headers = { 'Content-Type': 'application/json', ...options.headers };
                }
            }

            return fetch(url, options);
        }

        async function startSimulation() {
            if (!currentUserId) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!');
                return;
            }

            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('choiceScreen').style.display = 'flex';

            try {
                const response = await fetchWithUserId('/api/hourly/question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (response.status === 200) {
                    currentQuestionData = data;
                    renderChoiceScreen(data);
                } else {
                    alert(`ì˜¤ë¥˜: ${data.message}`);
                    goBackToHome();
                }
            } catch (error) {
                console.error('ì§ˆë¬¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                goBackToHome();
            }
        }

        async function showHistory() {
            if (!currentUserId) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!');
                return;
            }

            const container = document.getElementById('three-container');
            if (container) container.style.display = 'block';

            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('historyScreen').style.display = 'flex';

            if (window.initCharacter3D) {
                window.initCharacter3D();
            }

            try {
                const response = await fetchWithUserId('/api/hourly/history');
                const result = await response.json();

                const statsResponse = await fetchWithUserId('/api/hourly/raw-stats');
                const stats = await statsResponse.json();

                if (window.updateCharacter) {
                    window.updateCharacter.updateFinanceStatus(stats.finance);
                    window.updateCharacter.updateStudy(stats.grade);
                    window.updateCharacter.updateSleep(stats.sleep);
                }

                calculateAndDisplayTotalScores(result);
                const formattedHistory = formatHistoryData(result);
                renderHistoryList(formattedHistory);

            } catch (error) {
                console.error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        function calculateAndDisplayTotalScores(historyData) {
            let myTotalFinance = 0;
            let myTotalStudy = 0;
            let myTotalSleep = 0;

            let parallelTotalFinance = 0;
            let parallelTotalStudy = 0;
            let parallelTotalSleep = 0;

            if (historyData.actual_universe && Array.isArray(historyData.actual_universe)) {
                historyData.actual_universe.forEach(choice => {
                    myTotalFinance += choice.financeChange || 0;
                    myTotalStudy += choice.studyChangeMinutes || 0;
                    myTotalSleep += choice.sleepChangeMinutes || 0;
                });
            }

            if (historyData.parallel_universe && Array.isArray(historyData.parallel_universe)) {
                historyData.parallel_universe.forEach(branch => {
                    parallelTotalFinance += branch.oppositeFinanceChange || 0;
                    parallelTotalStudy += branch.oppositeStudyChangeMinutes || 0;
                    parallelTotalSleep += branch.oppositeSleepChangeMinutes || 0;
                });
            }

            const financeDiff = myTotalFinance - parallelTotalFinance;
            const studyDiff = myTotalStudy - parallelTotalStudy;
            const sleepDiff = myTotalSleep - parallelTotalSleep;

            updateTotalScoreDisplay('myTotalFinance', myTotalFinance, 'ì›');
            updateTotalScoreDisplay('myTotalStudy', myTotalStudy, 'ë¶„');
            updateTotalScoreDisplay('myTotalSleep', myTotalSleep, 'ë¶„');

            updateTotalScoreDisplay('parallelTotalFinance', parallelTotalFinance, 'ì›');
            updateTotalScoreDisplay('parallelTotalStudy', parallelTotalStudy, 'ë¶„');
            updateTotalScoreDisplay('parallelTotalSleep', parallelTotalSleep, 'ë¶„');

            updateDiffDisplay('financeDiff', financeDiff, 'ì›');
            updateDiffDisplay('studyDiff', studyDiff, 'ë¶„');
            updateDiffDisplay('sleepDiff', sleepDiff, 'ë¶„');
        }

        function updateTotalScoreDisplay(elementId, value, unit) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const formattedValue = value.toLocaleString();

            if (value > 0) {
                element.textContent = `+${formattedValue}${unit}`;
                element.style.color = '#6ee7b7';
            } else if (value < 0) {
                element.textContent = `${formattedValue}${unit}`;
                element.style.color = '#fca5a5';
            } else {
                element.textContent = `0${unit}`;
                element.style.color = '#9ca3af';
            }
        }

        function updateDiffDisplay(elementId, diff, unit) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const formattedDiff = Math.abs(diff).toLocaleString();

            if (diff > 0) {
                element.textContent = `+${formattedDiff}${unit}`;
                element.style.color = '#6ee7b7';
            } else if (diff < 0) {
                element.textContent = `-${formattedDiff}${unit}`;
                element.style.color = '#fca5a5';
            } else {
                element.textContent = `0${unit}`;
                element.style.color = '#9ca3af';
            }
        }

        function formatHistoryData(result) {
            const actualUniverse = result.actual_universe || [];
            const parallelUniverse = result.parallel_universe || [];

            const grouped = [];

            actualUniverse.forEach(actual => {
                const parallels = parallelUniverse.filter(
                    p => p.day === actual.day && p.hour === actual.hour
                );

                grouped.push({
                    actual: actual,
                    parallels: parallels
                });
            });

            return grouped;
        }

        async function showTimetableScreen() {
            if (!currentUserId) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!');
                return;
            }

            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('timetableScreen').style.display = 'flex';

            await loadSavedTimetable();
            initTimetableBody();
        }

        function initTimetableBody() {
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = '';

            for (let period of PERIODS) {
                const row = document.createElement('tr');
                const periodCell = document.createElement('td');
                periodCell.className = 'period-cell';
                periodCell.textContent = period + 'êµì‹œ';
                row.appendChild(periodCell);

                for (let dayIndex = 0; dayIndex < DAYS_KR.length; dayIndex++) {
                    const cell = document.createElement('td');
                    cell.className = 'timetable-cell';
                    const cellKey = dayIndex + '-' + period;
                    const cellData = timetableData.find(d => d.key === cellKey);
                    cell.textContent = cellData ? cellData.value : '';
                    cell.onclick = () => openTimetableModal(cellKey, period, DAYS_KR[dayIndex]);
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            }
        }

        function openTimetableModal(cellKey, period, day) {
            currentCellKey = cellKey;
            const cellData = timetableData.find(d => d.key === cellKey);
            document.getElementById('modalTitle').textContent = day + 'ìš”ì¼ ' + period + 'êµì‹œ';
            document.getElementById('timetableInput').value = cellData ? cellData.value : '';
            document.getElementById('timetableModal').style.display = 'flex';
            document.getElementById('timetableInput').focus();
        }

        function closeTimetableModal() {
            document.getElementById('timetableModal').style.display = 'none';
            document.getElementById('timetableInput').value = '';
            currentCellKey = '';
        }

        function saveTimetableCell() {
            const value = document.getElementById('timetableInput').value.trim();

            if (value === '') {
                timetableData = timetableData.filter(d => d.key !== currentCellKey);
            } else {
                const existingIndex = timetableData.findIndex(d => d.key === currentCellKey);
                if (existingIndex >= 0) {
                    timetableData[existingIndex].value = value;
                } else {
                    timetableData.push({ key: currentCellKey, value: value });
                }
            }

            closeTimetableModal();
            initTimetableBody();
        }

        document.getElementById('schedule-form-full').addEventListener('submit', async (e) => {
            e.preventDefault();

            const initialBudget = parseInt(document.getElementById('initial-budget-full').value, 10);

            if (isNaN(initialBudget) || initialBudget < 0) {
                alert("ìœ íš¨í•œ ì´ˆê¸° ì£¼ê°„ ì˜ˆì‚°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const schedule = {};
            const timetable_array = Array(DAYS.length).fill(null).map(() => Array(PERIODS.length).fill(0));

            DAYS.forEach(dayName => {
                schedule[dayName] = [];
            });

            timetableData.forEach(item => {
                const [dayIndex, period] = item.key.split('-').map(Number);
                const dayName = DAYS[dayIndex];
                const subject = item.value;
                const periodNum = period;

                if (subject) {
                    const timeDetail = TEMP_PERIOD_TIMES[periodNum];

                    const newClass = {
                        subject: subject,
                        start: timeDetail.start,
                        end: timeDetail.end
                    };

                    if (!schedule[dayName]) {
                        schedule[dayName] = [];
                    }
                    schedule[dayName].push(newClass);

                    const periodIndex = periodNum - 1;
                    if (dayIndex !== -1 && periodIndex !== -1) {
                        timetable_array[dayIndex][periodIndex] = 1;
                    }
                }
            });

            try {
                const response = await fetchWithUserId('/api/hourly/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schedule,
                        initialBudget,
                        timetable_array
                    })
                });

                const data = await response.json();

                if (response.status === 201) {
                    alert(`âœ… ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ˆê¸° ì˜ˆì‚°: ${data.settings.initialBudget.toLocaleString()}ì›`);
                    goBackToHome();
                } else {
                    alert(`ì„¤ì • ì €ì¥ ì˜¤ë¥˜: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('ì‹œê°„í‘œ ì €ì¥ ì˜¤ë¥˜: ', error);
                alert(`ì„œë²„ì™€ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
            }
        });

        function renderChoiceScreen(data) {
            allFinalOptions = data.options;

            if (!data) {
                alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                goBackToHome();
                return;
            }

            if (!data.options || !Array.isArray(data.options) || data.options.length === 0) {
                document.getElementById('choice-question').textContent = data.message || "í‘œì‹œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
                document.getElementById('choice-context').textContent = "";
                document.getElementById('choice-options-container').innerHTML = '';

                document.getElementById('cost-input-area').style.display = 'none';
                document.getElementById('description-input-area').style.display = 'none';
                document.getElementById('save-choice-btn').style.display = 'none';

                return;
            }

            document.getElementById('choice-question').textContent = data.question;

            const dayNameKr = data.day !== undefined && data.day >= 0 && data.day < 5 ? DAYS_KR[data.day] : 'ì˜¤ëŠ˜';
            document.getElementById('choice-context').textContent = `ìœ í˜•: ${data.choiceType} (${data.subject || dayNameKr} ${data.hour}ì‹œ)`;

            const optionsContainer = document.getElementById('choice-options-container');
            optionsContainer.innerHTML = '';

            data.options.forEach(option => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'choice-item';
                button.innerHTML = `<span>${option.label}</span>`;

                button.dataset.value = option.value;
                button.dataset.hasCost = option.hasCost;
                button.dataset.costPrompt = option.costPrompt || '';
                button.dataset.needsDescription = option.needsDescription || false;

                button.dataset.optionData = JSON.stringify({
                    value: option.value,
                    label: option.label,
                    category: option.category || ''
                });

                button.addEventListener('click', handleOptionSelect);
                optionsContainer.appendChild(button);
            });

            selectedChoice = null;
            parallelChoiceData = null;
            document.getElementById('cost-input-area').style.display = 'none';
            document.getElementById('description-input-area').style.display = 'none';
            document.getElementById('cost-value').value = 0;
            document.getElementById('custom-description').value = '';
            document.getElementById('save-choice-btn').style.display = 'block';
        }

        function handleOptionSelect(event) {
            const btn = event.currentTarget;
            const buttons = document.querySelectorAll('#choice-options-container .choice-item');

            buttons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');

            selectedChoice = btn.dataset.value;

            if (btn.dataset.value === 'attend_base' || btn.dataset.value === 'skip_base') {
                const subject = currentQuestionData.subject || "ìˆ˜ì—…";
                fetchBranchQuestion(currentQuestionData.day, currentQuestionData.hour, subject, btn.dataset.value);
                document.getElementById('save-choice-btn').style.display = 'none';
                return;
            }

            const unselectedButtons = Array.from(buttons).filter(b => !b.classList.contains('selected'));

            window.currentParallelChoices = [];

            unselectedButtons.forEach(otherBtn => {
                let data = {};

                try {
                    data = JSON.parse(otherBtn.dataset.optionData || '{}');
                } catch (e) {
                    console.error("Option Data íŒŒì‹± ì˜¤ë¥˜:", e);
                }

                window.currentParallelChoices.push({
                    value: data.value || otherBtn.dataset.value,
                    label: data.label || otherBtn.innerText,
                    category: data.category || '',
                    cost: 0,
                    description: `(í‰í–‰ìš°ì£¼) '${data.label || otherBtn.innerText}' ì„ íƒ`
                });
            });

            let selectedOptionData = {};
            try {
                selectedOptionData = JSON.parse(btn.dataset.optionData || '{}');
            } catch (e) { }

            const hasCost = btn.dataset.hasCost === 'true';
            const needsDescription = btn.dataset.needsDescription === 'true';

            const costArea = document.getElementById('cost-input-area');
            const descArea = document.getElementById('description-input-area');
            const saveBtn = document.getElementById('save-choice-btn');

            if (hasCost) {
                costArea.style.display = 'block';
                document.getElementById('cost-prompt-label').textContent = btn.dataset.costPrompt || 'ë¹„ìš©ì€ ì–¼ë§ˆì˜€ë‚˜ìš”?';
            } else {
                costArea.style.display = 'none';
                document.getElementById('cost-value').value = 0;
            }

            if (needsDescription) {
                descArea.style.display = 'block';
            } else {
                descArea.style.display = 'none';
                document.getElementById('custom-description').value = '';
            }

            saveBtn.style.display = 'block';
        }

        async function fetchBranchQuestion(day, hour, subject, baseChoice) {
            const response = await fetchWithUserId('/api/hourly/branch-question', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ day, hour, subject, baseChoice })
            });

            if (response.ok) {
                const branchData = await response.json();
                updateQuestionUI(branchData);
            } else {
                const errorData = await response.json().catch(() => ({ message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜' }));
                console.error('2ë‹¨ê³„ ì§ˆë¬¸ ì˜¤ë¥˜:', errorData);
                alert(`2ë‹¨ê³„ ì§ˆë¬¸ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorData.message}`);
            }
        }

        function updateQuestionUI(data) {
            currentQuestionData = data;
            allFinalOptions = data.options;

            document.getElementById('choice-question').textContent = data.question;

            const dayNameKr = data.day !== undefined && data.day >= 0 && data.day < 5 ? DAYS_KR[data.day] : 'ì˜¤ëŠ˜';
            document.getElementById('choice-context').textContent = `ìœ í˜•: ${data.choiceType} (${data.subject || dayNameKr} ${data.hour}ì‹œ)`;

            const optionsContainer = document.getElementById('choice-options-container');
            optionsContainer.innerHTML = '';

            data.options.forEach(option => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'choice-item';
                button.innerHTML = `<span>${option.label}</span>`;

                button.dataset.value = option.value;
                button.dataset.hasCost = option.hasCost;
                button.dataset.costPrompt = option.costPrompt || '';
                button.dataset.needsDescription = option.needsDescription || false;

                button.dataset.optionData = JSON.stringify({
                    value: option.value,
                    label: option.label,
                    category: option.category || ''
                });

                button.addEventListener('click', handleOptionSelect);
                optionsContainer.appendChild(button);
            });

            selectedChoice = null;
            document.getElementById('cost-input-area').style.display = 'none';
            document.getElementById('description-input-area').style.display = 'none';
            document.getElementById('save-choice-btn').style.display = 'none';
        }

        document.getElementById('activity-choice-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedChoice) {
                alert('ì„ íƒì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const selectedOptionElement = document.querySelector(`#choice-options-container .choice-item[data-value="${selectedChoice}"]`);

            // ğŸ”§ ë¹„ìš© ì²˜ë¦¬: hasCostê°€ trueì¼ ë•Œë§Œ ì…ë ¥ê°’ ì‚¬ìš©, ì•„ë‹ˆë©´ 0
            let cost = 0;
            const hasCost = selectedOptionElement && selectedOptionElement.dataset.hasCost === 'true';

            if (hasCost) {
                cost = parseInt(document.getElementById('cost-value').value, 10);
                if (isNaN(cost)) {
                    alert("ìœ íš¨í•œ ë¹„ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
            }

            // ì„¤ëª… ì…ë ¥ ê²€ì¦
            let customDescription = '';
            if (selectedOptionElement && selectedOptionElement.dataset.needsDescription === 'true') {
                customDescription = document.getElementById('custom-description').value.trim();
                if (!customDescription) {
                    alert("í™œë™ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
            }

            const selectedOption = allFinalOptions.find(opt => opt.value === selectedChoice);
            const selectedCategory = selectedOption ? selectedOption.category : null;

            const parallelChoicesPayload = allFinalOptions
                .filter(option => option.value !== selectedChoice)
                .map(option => {
                    let oppositeCost = 0;
                    if (option.value === 'attend_coffee') oppositeCost = -4000;
                    if (option.value === 'skip_play') oppositeCost = -10000;

                    return {
                        value: option.value,
                        cost: oppositeCost,
                        label: option.label,
                        category: option.category || null
                    };
                });

            const payload = {
                day: currentQuestionData.day,
                hour: currentQuestionData.hour,
                choiceType: currentQuestionData.choiceType,
                subject: currentQuestionData.subject,

                choice: selectedChoice,
                cost: cost,
                duration: 75,
                customDescription: customDescription || undefined,
                parallelChoices: parallelChoicesPayload,
                category: selectedCategory
            };

            console.log('ğŸ“¤ ì „ì†¡í•  ë°ì´í„°:', payload);

            try {
                const response = await fetchWithUserId('/api/hourly/choices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('ğŸ“¡ ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);

                let data;
                try {
                    data = await response.json();
                    console.log('ğŸ“¦ ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data);
                } catch (jsonError) {
                    console.error('âŒ JSON íŒŒì‹± ì˜¤ë¥˜:', jsonError);
                    alert('ì„œë²„ ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                if (response.status === 201) {
                    console.log('âœ… ì €ì¥ ì„±ê³µ!');

                    // 3D ìºë¦­í„° ì—…ë°ì´íŠ¸
                    if (data.currentScores && window.updateCharacter) {
                        try {
                            window.updateCharacter.updateFinanceStatus(data.currentScores.finance);
                            window.updateCharacter.updateStudy(data.currentScores.study);
                            window.updateCharacter.updateSleep(data.currentScores.sleep);
                        } catch (characterError) {
                            console.error('âš ï¸ 3D ìºë¦­í„° ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', characterError);
                            // ìºë¦­í„° ì˜¤ë¥˜ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
                        }
                    }

                    alert(`âœ… í™œë™ ì €ì¥ ì™„ë£Œ!\n\ní˜„ì¬ ì˜ˆì‚°: ${data.actual_universe.currentBudget.toLocaleString()}ì›`);

                    // íˆìŠ¤í† ë¦¬ë¡œ ì´ë™
                    try {
                        await showHistory();
                    } catch (historyError) {
                        console.error('âš ï¸ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', historyError);
                        // íˆìŠ¤í† ë¦¬ ì˜¤ë¥˜ê°€ ìˆì–´ë„ ì €ì¥ì€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ í™ˆìœ¼ë¡œ
                        goBackToHome();
                    }
                } else if (response.status === 400) {
                    // ì¤‘ë³µ ì €ì¥ ì‹œë„ ë“±ì˜ 400 ì˜¤ë¥˜
                    console.warn('âš ï¸ ìš”ì²­ ì˜¤ë¥˜:', data);
                    alert(`âš ï¸ ${data.message}\n\níˆìŠ¤í† ë¦¬ì—ì„œ ê¸°ì¡´ ì„ íƒì„ í™•ì¸í•˜ì„¸ìš”.`);
                    // íˆìŠ¤í† ë¦¬ë¡œ ì´ë™
                    try {
                        await showHistory();
                    } catch (historyError) {
                        goBackToHome();
                    }
                } else {
                    console.error('âŒ ì„œë²„ ì‘ë‹µ:', data);
                    alert(`âŒ í™œë™ ì €ì¥ ì˜¤ë¥˜: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('ğŸ’¥ í™œë™ ì €ì¥ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
                alert(`ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${error.message}`);
            }
        });

        function goBackToHome() {
            document.getElementById('choiceScreen').style.display = 'none';
            document.getElementById('timetableScreen').style.display = 'none';
            document.getElementById('historyScreen').style.display = 'none';
            document.getElementById('homeScreen').style.display = 'flex';

            const container = document.getElementById('three-container');
            if (container) container.style.display = 'none';
        }

        async function loadSavedTimetable() {
            try {
                const response = await fetchWithUserId('/api/hourly/settings');

                if (response.status === 200) {
                    const data = await response.json();
                    const schedule = data.schedule;

                    timetableData = [];

                    DAYS.forEach((dayName, dayIndex) => {
                        const classesOnDay = schedule[dayName] || [];

                        classesOnDay.forEach(classInfo => {
                            for (let period = 1; period <= 6; period++) {
                                const periodTime = TEMP_PERIOD_TIMES[period];
                                if (classInfo.start === periodTime.start) {
                                    const cellKey = `${dayIndex}-${period}`;
                                    timetableData.push({
                                        key: cellKey,
                                        value: classInfo.subject
                                    });
                                    break;
                                }
                            }
                        });
                    });

                    document.getElementById('initial-budget-full').value = data.settings.initialBudget;

                    if (document.getElementById('timetableScreen').style.display === 'flex') {
                        initTimetableBody();
                    }
                }
            } catch (error) {
                console.error('ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            }
        }

        async function resetAllData() {
            if (!currentUserId) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!');
                return;
            }

            const confirmed = confirm("âš ï¸ ê²½ê³ !\n\nëª¨ë“  ì„ íƒ íˆìŠ¤í† ë¦¬ì™€ í†µê³„ê°€ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");

            if (!confirmed) return;

            try {
                const response = await fetchWithUserId('/api/hourly/reset', {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.status === 200) {
                    alert("âœ… ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");

                    timetableData = [];
                    initTimetableBody();
                } else {
                    alert(`ì´ˆê¸°í™” ì˜¤ë¥˜: ${data.message}`);
                }
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function formatChange(value, unit) {
            if (value === null || value === undefined) return `0${unit}`;
            if (value > 0) {
                return `<span style="color: #6ee7b7;">+${value.toLocaleString()}${unit}</span>`;
            } else if (value < 0) {
                return `<span style="color: #fca5a5;">${value.toLocaleString()}${unit}</span>`;
            } else {
                return `0${unit}`;
            }
        }

        function renderHistoryList(historyData) {
            const listContainer = document.getElementById('historyList');
            listContainer.innerHTML = '';

            if (!historyData || historyData.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #aaa;">ì•„ì§ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const latestEntry = historyData[historyData.length - 1];
            const latestActual = latestEntry.actual;

            const latestFinance = latestActual.currentBudget / 10000;
            const latestStudy = latestActual.currentStudyScore || 50;
            const latestSleep = latestActual.currentSleepScore || 50;

            const financePercent = Math.min(100, Math.max(0, latestFinance));
            const studyPercent = Math.min(100, Math.max(0, latestStudy));
            const sleepPercent = Math.min(100, Math.max(0, latestSleep));

            if (window.updateCharacter) {
                window.updateCharacter.updateFinanceStatus(financePercent);
                window.updateCharacter.updateStudy(studyPercent);
                window.updateCharacter.updateSleep(sleepPercent);
            }

            historyData.forEach((entry) => {
                const a = entry.actual;
                const dayNameKr = DAYS_KR[a.day] || `Day ${a.day + 1}`;

                let actualHtml = `
            <div class="universe-container actual-universe">
                <div class="universe-title">âœ¨ ë‚˜ì˜ ìš°ì£¼ ì„ íƒ (${dayNameKr} ${a.hour}ì‹œ)</div>
                <p class="universe-description">${a.description}</p>
                <div class="universe-stats">
                    <span>ğŸ’° ì¬ì •: ${formatChange(a.financeChange || 0, 'ì›')}</span>
                    <span>ğŸ“š í•™ìŠµ: ${formatChange(a.studyChangeMinutes || 0, 'ë¶„')}</span>
                    <span>ğŸ˜´ ìˆ˜ë©´: ${formatChange(a.sleepChangeMinutes || 0, 'ë¶„')}</span>
                </div>
            </div>
        `;

                let parallelHtml = '';
                if (entry.parallels.length === 0) {
                    parallelHtml = `
                <div class="universe-container parallel-universe no-parallel">
                    <div class="universe-title">ğŸŒŒ í‰í–‰ ìš°ì£¼</div>
                    <p class="universe-description">ê¸°ë¡ëœ í‰í–‰ ìš°ì£¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            `;
                } else {
                    entry.parallels.forEach((p, index) => {
                        parallelHtml += `
                    <div class="universe-container parallel-universe ${index > 0 ? 'mt-2' : ''}">
                        <div class="universe-title">ğŸŒŒ í‰í–‰ ìš°ì£¼ (ì„ íƒí•˜ì§€ ì•Šì€ ê¸¸)</div>
                        <p class="universe-description">${p.oppositeDescription}</p>
                        <div class="universe-stats">
                            <span>ğŸ’° ì¬ì •: ${formatChange(p.oppositeFinanceChange || 0, 'ì›', true)}</span>
                            <span>ğŸ“š í•™ìŠµ: ${formatChange(p.oppositeStudyChangeMinutes || 0, 'ë¶„', false)}</span>
                            <span>ğŸ˜´ ìˆ˜ë©´: ${formatChange(p.oppositeSleepChangeMinutes || 0, 'ë¶„', false)}</span>
                        </div>
                    </div>
                `;
                    });
                }

                const itemHtml = `
            <div class="history-item">
                <div class="history-header">
                    <span class="history-time">${dayNameKr} ${a.hour}ì‹œ</span>
                    <span class="history-type">${a.choiceType || 'ì¼ë°˜ í™œë™'}</span>
                </div>
                ${actualHtml}
                ${parallelHtml}
            </div>
        `;
                listContainer.insertAdjacentHTML('beforeend', itemHtml);
            });
        }
    </script>
    <script type="module">
        import {
            initThreeScene,
            updateStudy,
            updateSleep,
            updateFinanceStatus
        } from "./threeScene.js";

        window.initCharacter3D = initThreeScene;

        window.updateCharacter = {
            updateStudy,
            updateSleep,
            updateFinanceStatus
        };
    </script>
</body>

</html>